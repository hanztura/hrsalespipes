{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}
Dashboard
{% endblock title %}

{% block headblock %}
  <style>
    .rotate-90 {
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        transform: rotate(90deg);
    }
  </style>  
{% endblock headblock %}


{% block subcontent %}
  <input type="hidden" id="dataDashboardItemsNumber" value="{{ dashboard_items_number }}">
  <input type="hidden" id="dataSuccessfulJobsAllTimePerIndustry" value="{{ sjatpi }}">
  <input type="hidden" id="dataSuccessfulJobsPerConsutant" value="{{ sjpc }}">
  <input type="hidden" id="dataTNFIPerConsultant" value="{{ tnfipc }}">
  <input type="hidden" id="dataTNFIPerConsultantLast12Months" value="{{ tnfipcp12m }}">
  <input type="hidden" id="dataYTDClientPerformance" value="{{ ytdcp }}">
  <v-container
    fluid>
    <h1>Dashboard</h1>
    {% if data_note %}<span class="caption">{{ data_note }}</span>{% endif %}

    <v-row
      align="center"
      justify="center"
    >
      <dashboard-value-card
        v-for="item in dashboardItemsNumber"
        :key="item.title"
        :text="item.title"
        :value="item.value"></dashboard-value-card>
    </v-row>
    <v-row
      align="center"
      justify="center"
    >
      <v-col
        cols=12
        md=6
        v-for="graph in graphItems"
        :key="graph.title"
        height="100%">
        <graph-card
          :chart-data="graph.data"
          :default-chart-type="'ColumnChart'"
          :chart-types="chartTypes"
          :title="graph.title"
          :href="graph.href"></graph-card>
      </v-col>
    </v-row>
  </v-container>  
{% endblock subcontent %}

{% block script %}

{% if debug %}
  <script src="{% static "vendor/lodash/lodash.js" %}"></script>
  <script src="{% static "vendor/vue-google-charts/vue-google-charts.browser.js" %}"></script>
  <script src="{% static "vendor/AnimatedNumber.umd.min.js" %}"></script>
{% else %}
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-google-charts@0.3.2/dist/vue-google-charts.browser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animated-number-vue@1.0.0/dist/AnimatedNumber.umd.min.js"></script>
{% endif %}
<script>
  Vue.component('animated-number', AnimatedNumber)
  const DashboardValueCard = {
    props: ['value', 'text'],
    template: `
      <v-col cols="12" md=4>
        <v-card
          class="mx-auto text-center"
          outlined
          elevation=1>
          <v-card-text>
            <p class="font-weight-black headline">
              <animated-number
                class="display-1"
                :value="value"
                :duration="2000"
                :round="0"/>
            </p>
            <p class="title mb-0">[[ text ]]</p>
          </v-card-text>
        </v-card>
      </v-col>
    `,
  }

  Vue.component('graph-card', {
    name: 'GraphCard',
    props: [
      'chartData',
      'defaultChartType',
      'chartTypes',
      'title',
      'href',
    ],
    data: () => {
      return {
        chartType: 'ColumnChart',
      }
    },

    computed: {
      hasData: function() {
        return this.chartData.length > 1
      }
    },

    mounted() {
      this.chartType = this.defaultChartType;
    },

    template: `
      <v-card
        class="mx-auto text-center"
        color="primary"
        outlined
        dark
        elevation=1>
        <v-card-text>
          <div class="title font-weight-thin"><a class="white--text" :href="href">[[ title ]]</a></div>
        </v-card-text>

        <template v-if="hasData">
          <v-card-text>
            <v-sheet>
              <g-chart
                :type="chartType"
                :data="chartData"
              />
            </v-sheet>
          </v-card-text>

          <v-card-actions>
            <v-row align="center" justify="center">
              <v-btn
                class="mx-2"
                v-for="ct in chartTypes"
                :key="ct.type"
                :title="ct.text"
                @click="changeChartType(ct.type)">
                <v-icon>[[ ct.icon ]]</v-icon>
              </v-btn>
            </v-row>
          </v-card-actions>
        </template>

        <v-card-text v-else>
          <v-sheet color="rgba(0, 0, 0, .12)">
            <p>No data available.</p>
          </v-sheet>
        </v-card-text>
      </v-card>
    `,
    methods: {
      changeChartType: function(value) {
        this.chartType = value;
      },
    }
  })

  new Vue({
    name: 'DashboardApp',
    el: '#inspire',
    vuetify: new Vuetify(),

    data: () => ({
      drawer: null,
      subBreadcrumbs: [],
      chartTypes: [
        {
          'type': 'ColumnChart',
          'text': 'Column',
          'icon': 'mdi-chart-bar',
        },
        {
          'type': 'BarChart',
          'text': 'Bar',
          'icon': 'mdi-chart-bar rotate-90',
        },
        {
          'type': 'PieChart',
          'text': 'Pie',
          'icon': 'mdi-chart-pie',
        },
        {
          'type': 'LineChart',
          'text': 'Line',
          'icon': 'mdi-chart-line',
        },
      ],
      dashboardItemsNumber: [],
      sjatpi: [["Industry","Successful jobs per industry"]],
      sjpc: [["Consultant","Successful jobs per consultant this month"]],
      tnfipc: [["Consultant", "Total NFI generated per consultant this month"]],
      tnfipcp12m: [["Consultant", "Total NFI generated per consultant last 12 months"]],
      ytdcp: [],
      transformTheseData: [
        {
          sourceId: 'dataSuccessfulJobsAllTimePerIndustry',
          dataField: 'sjatpi',
          titleField: 'job_candidate__job__client__industry',
        },
        {
          sourceId: 'dataSuccessfulJobsPerConsutant',
          dataField: 'sjpc',
          titleField: 'job_candidate__consultant__name',
        },
        {
          sourceId: 'dataTNFIPerConsultant',
          dataField: 'tnfipc',
          titleField: 'job_candidate__consultant__name',
        },
        {
          sourceId: 'dataTNFIPerConsultantLast12Months',
          dataField: 'tnfipcp12m',
          titleField: 'job_candidate__consultant__name',
        },
      ],
    }),

    computed: {
      graphItems: function() {
        return [
          this.sjatpi,
          this.sjpc,
          this.tnfipc,
          this.tnfipcp12m,
          this.ytdcpData,
        ]
      },
      ytdcpDataBySources: function(){
        // get sources
        let sources = _.groupBy(this.ytdcp.value, 'cvSource');
        return sources;
      },
      ytdcpDataByClientId: function(){
        let clients = _.groupBy(this.ytdcp.value, 'id');
        return clients
      },
      transformedYTDCP: function(){
        ytdcp = [
          ['Client', 'Total'],
        ]
        let sources = _.keys(this.ytdcpDataBySources);

        _.forEach(sources, (source, index) => {
          ytdcp[0].push(source) - 1;

          // _.forEach(_this.ytdcpDataBySources[source], (row) => {
          //   let data = new Array(sources.length + 1);
          //   data[0] = row.client;
          //   data[sourceIndex] = row.value;
          //   ytdcp.push(data);
          // });
        });

        _.forEach(this.ytdcpDataByClientId, (rows, clientId)=>{
          let data = new Array(sources.length + 2);
          let total = 0;

          _.forEach(rows, (row, index) => {
            let source = row.cvSource;
            let sourceIndex = ytdcp[0].indexOf(source);

            // set client name
            if (index == 0) { data[0] = row.client }
            data[sourceIndex] = row.value;
            total += row.value;
          });

          data[1] = total;
          ytdcp.push(data);
        });
        return ytdcp;
      },
      ytdcpData: function() {
        let data = {
          title: this.ytdcp.title,
          data: this.transformedYTDCP,
          href: this.ytdcp.url
        }
        return data;
      }
    },

    methods: {
      setDataChoices: function(sourceId, setDataVariable) {
        let data = document.getElementById(sourceId).value;
        this.$set(this, setDataVariable, JSON.parse(data));
      },
      changeChartType: function(property, value) {
        this.$set(this, property, value);
      },
      transformGraphData: function(sourceId, dataField, titleField) {
        let data = document.getElementById(sourceId).value;
        data = JSON.parse(data);

        // set value label
        this.$set(this[dataField][0], 1, data.title);
        // this.sjpc[0][1] = data.title;

        // transform data to be consumed by a graph
        let title = data.title;
        let href = data.url;
        data = _.map(data.value, (graph) => {
          // graph is the value attribute from django
          let value = graph.value ? graph.value : [];
          return [
            graph[titleField],
            value
          ]
        });
        data = this[dataField].concat(data);
        data = {
          data: data,
          title: title,
          href: href
        }

        this.$set(this, dataField, data);
      },
      setGraphData: function() {
        let _this = this;

        _.forEach(this.transformTheseData, (data) => {
          _this.transformGraphData(data.sourceId, data.dataField, data.titleField);
        });
      }
    },

    beforeMount(){
      this.setGraphData();
    },

    mounted() {
      this.updateBreadcrumbs();
      this.setDataChoices('dataDashboardItemsNumber', 'dashboardItemsNumber');
      this.setDataChoices('dataYTDClientPerformance', 'ytdcp');
    },

    components: {
      'dashboard-value-card': DashboardValueCard,
    }

  });
</script>  
{% endblock script %}